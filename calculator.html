<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî Auto GBP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#050608;
      --card:#0d0d11;
      --border:#262935;
      --gold:#ffd86a;
      --gold2:#c69528;
      --text:#f7f7f7;
      --muted:#a0a0a0;
      --ok:#65d96b;
      --radius:18px;
      --shadow:0 18px 40px rgba(0,0,0,.70);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#141821 0,#020308 55%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    a{color:var(--gold);text-decoration:none}
    .container{width:min(1120px,100% - 32px);margin:0 auto}

    /* Top */
    .top{
      position:sticky;top:0;z-index:20;
      backdrop-filter:blur(18px);
      background:linear-gradient(to bottom, rgba(5,6,8,.96), rgba(5,6,8,.85));
      border-bottom:1px solid rgba(255,216,106,.18);
    }
    .top-inner{
      display:flex;flex-direction:column;gap:10px;
      padding:12px 0 14px;
      align-items:center;text-align:center;
    }
    .brand{display:flex;align-items:center;gap:10px;justify-content:center}
    .logo{
      width:34px;height:34px;border-radius:50%;
      background:radial-gradient(circle at 30% 20%, #ffeaa0, var(--gold2));
      box-shadow:0 0 0 1px rgba(0,0,0,.6), 0 0 18px rgba(255,216,106,.45);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .logo img{width:120%;height:auto;display:block}
    .brand-title{
      font-weight:1000;letter-spacing:4px;font-size:18px;
      color:var(--gold);
      text-shadow:0 0 18px rgba(255,216,106,.18);
    }
    .brand-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .nav{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;font-size:14px}
    .nav a{
      color:rgba(255,255,255,.78);
      padding:7px 12px;border-radius:999px;
      border:1px solid transparent;
      transition:.15s ease;
      background:rgba(255,216,106,0.03);
    }
    .nav a:hover{border-color:rgba(255,216,106,.35);color:#fff}
    .nav a.active{
      background:linear-gradient(135deg, var(--gold), var(--gold2));
      color:#000;font-weight:900;
      box-shadow:0 0 18px rgba(255,216,106,.35);
    }

    /* Layout */
    .hero{padding:18px 0 6px}
    .hero h1{margin:0;font-size:22px}

    .grid{
      display:grid;
      grid-template-columns:minmax(0,3.2fr) minmax(0,2.3fr);
      gap:18px;
      align-items:flex-start;
      padding:16px 0 40px;
    }
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:radial-gradient(circle at top left, #1a1a22, #05050a);
      border-radius:var(--radius);
      padding:18px 16px 16px;
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow);
    }
    .section-title{
      margin:14px 0 10px;
      font-size:12px;
      letter-spacing:1px;
      color:rgba(255,216,106,.95);
      text-transform:uppercase;
    }
    .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:rgba(255,255,255,.72);margin-bottom:5px}
    input,select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(9,11,18,.95);
      color:var(--text);
      font-size:14px;
      outline:none;
      transition:.16s ease;
    }
    input:focus,select:focus{
      border-color:rgba(255,216,106,.65);
      box-shadow:0 0 0 1px rgba(255,216,106,.25);
      background:#10121b;
    }

    .btn-row{display:flex;gap:10px;margin-top:10px}
    @media (max-width:640px){.btn-row{flex-direction:column}}
    .btn{
      width:100%;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:11px 14px;border-radius:999px;
      border:1px solid rgba(255,216,106,.25);
      background:rgba(255,216,106,.06);
      color:var(--text);
      font-weight:900;font-size:13px;
      cursor:pointer;transition:.15s ease;
    }
    .btn:hover{border-color:rgba(255,216,106,.55);background:rgba(255,216,106,.10)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      border:none;
      background:linear-gradient(135deg, var(--gold), var(--gold2));
      color:#000;
      box-shadow:0 12px 28px rgba(0,0,0,.75);
    }

    /* Result */
    .result-top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .sum{font-size:26px;font-weight:1000}
    .uah{margin-top:4px;color:var(--ok);font-weight:900;font-size:13px}
    .tag{
      font-size:11px;padding:3px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.70);
      white-space:nowrap;
    }
    .mini{margin-top:6px;color:rgba(255,255,255,.60);font-size:11.5px;line-height:1.35}
    .block{margin-top:12px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.10);font-size:13px}
    .r{display:flex;justify-content:space-between;gap:12px;margin:6px 0}
    .r span:first-child{color:rgba(255,255,255,.72)}
    .r span:last-child{font-variant-numeric:tabular-nums}
    .hl{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,216,106,.25);font-weight:1000}

    .status{margin-top:8px;font-size:12px;color:rgba(255,255,255,.65)}
    footer{border-top:1px solid rgba(255,255,255,.05);padding:14px 0 22px;text-align:center;color:var(--muted);font-size:11px}
  </style>
</head>

<body>
  <div class="top">
    <div class="container top-inner">
      <div class="brand">
        <div class="logo"><img src="logo-gbp.png" alt="Auto GBP"></div>
        <div>
          <div class="brand-title">AUTO GBP</div>
          <div class="brand-sub">Grand Best Performance ¬∑ Dubno</div>
        </div>
      </div>
      <div class="nav">
        <a href="index.html">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="cars.html">–ê–≤—Ç–æ</a>
        <a class="active" href="calculator.html">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
        <a href="index.html#contact">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="hero">
      <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞—Ä—Ç–æ—Å—Ç—ñ –∞–≤—Ç–æ</h1>
    </section>

    <section class="grid">
      <!-- LEFT -->
      <div class="card">
        <form id="calc-form" autocomplete="off">
          <div class="section-title">–õ–æ—Ç / VIN</div>

          <div class="row">
            <div>
              <label for="auctionUrl">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ª–æ—Ç (Copart/IAAI)</label>
              <input id="auctionUrl" name="auctionUrl" type="url" placeholder="https://www.iaai.com/.../VehicleDetail/44421501~US" />
            </div>
            <div>
              <label for="vin">VIN</label>
              <input id="vin" name="vin" type="text" placeholder="1FM5K8AR2JGA89957" />
            </div>
          </div>

          <div class="btn-row">
            <button class="btn" type="button" id="recognizeLotBtn">üîé –†–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ –ª–æ—Ç</button>
            <button class="btn btn-primary" type="button" id="decodeVinBtn">‚ö° –ü—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –ø–æ VIN</button>
          </div>

          <div class="status" id="shortStatus"></div>

          <div class="section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏</div>

          <div class="row">
            <div>
              <label for="year">–†—ñ–∫</label>
              <input type="number" id="year" name="year" min="1995" max="2035" placeholder="2020" />
            </div>
            <div>
              <label for="fuel">–ü–∞–ª–∏–≤–æ</label>
              <select id="fuel" name="fuel">
                <option value="gasoline">–ë–µ–Ω–∑–∏–Ω</option>
                <option value="diesel">–î–∏–∑–µ–ª—å</option>
                <option value="hybrid">–ì—ñ–±—Ä–∏–¥</option>
                <option value="electric">–ï–ª–µ–∫—Ç—Ä–æ</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="engine">–û–± º—î–º, —Å–º¬≥</label>
              <input type="number" id="engine" name="engine" placeholder="2000" />
            </div>
            <div>
              <label for="auction">–ê—É–∫—Ü—ñ–æ–Ω</label>
              <select id="auction" name="auction">
                <option value="Copart">Copart</option>
                <option value="IAAI">IAAI</option>
                <option value="Manheim">Manheim</option>
                <option value="other">–Ü–Ω—à–∏–π</option>
              </select>
            </div>
          </div>

          <div class="section-title">–¶—ñ–Ω–∞ / –õ–æ–≥—ñ—Å—Ç–∏–∫–∞</div>

          <div class="row">
            <div>
              <label for="lotPrice">–¶—ñ–Ω–∞ –∞–≤—Ç–æ, $</label>
              <input type="number" id="lotPrice" name="lotPrice" placeholder="20000" />
            </div>
            <div>
              <label for="auctionFee">–ê—É–∫—Ü—ñ–æ–Ω–Ω—ñ –∑–±–æ—Ä–∏, $</label>
              <input type="number" id="auctionFee" name="auctionFee" placeholder="1200" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="shipUsa">–°—É—à–∞ (–¥–æ –ø–æ—Ä—Ç—É), $</label>
              <input type="number" id="shipUsa" name="shipUsa" placeholder="0" />
            </div>
            <div>
              <label for="shipSea">–ú–æ—Ä–µ, $</label>
              <input type="number" id="shipSea" name="shipSea" placeholder="1350" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="arrival">–ü—É–Ω–∫—Ç –ø—Ä–∏–±—É—Ç—Ç—è</label>
              <select id="arrival" name="arrival">
                <option value="Klaipeda">–ö–ª–∞–π–ø–µ–¥–∞</option>
                <option value="Gdansk">–ì–¥–∞–Ω—Å—å–∫</option>
                <option value="Bremerhaven">–ë—Ä–µ–º–µ—Ä—Ö–∞—Ñ–µ–Ω</option>
                <option value="Rotterdam">–†–æ—Ç—Ç–µ—Ä–¥–∞–º</option>
                <option value="Chornomorsk">–ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫</option>
                <option value="Other">–Ü–Ω—à–µ</option>
              </select>
            </div>
            <div>
              <label for="shipEuLand">–Ñ–≤—Ä–æ–ø–∞ —Å—É—à–∞, $</label>
              <input type="number" id="shipEuLand" name="shipEuLand" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="portFees">–ü–æ—Ä—Ç–æ–≤—ñ, $</label>
              <input type="number" id="portFees" name="portFees" placeholder="0" />
            </div>
            <div>
              <label for="shipUa">–£–∫—Ä–∞—ó–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞, $</label>
              <input type="number" id="shipUa" name="shipUa" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="dealerFee">–ü–æ—Å–ª—É–≥–∏ Auto GBP, $</label>
              <input type="number" id="dealerFee" name="dealerFee" placeholder="0" />
            </div>
            <div>
              <label for="servicePackage">–ö–æ–º–ø–ª–µ–∫—Å –ø–æ—Å–ª—É–≥, $</label>
              <input type="number" id="servicePackage" name="servicePackage" placeholder="0" />
            </div>
          </div>

          <div class="section-title">–ü–æ–¥–∞—Ç–∫–∏</div>

          <div class="row">
            <div>
              <label for="dutyRate">–ú–∏—Ç–æ, %</label>
              <input type="number" id="dutyRate" name="dutyRate" value="10" />
            </div>
            <div>
              <label for="vatRate">–ü–î–í, %</label>
              <input type="number" id="vatRate" name="vatRate" value="20" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="cert">–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è, $</label>
              <input type="number" id="cert" name="cert" placeholder="0" />
            </div>
            <div>
              <label for="reg">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è, $</label>
              <input type="number" id="reg" name="reg" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="repair">–†–µ–º–æ–Ω—Ç, $</label>
              <input type="number" id="repair" name="repair" placeholder="0" />
            </div>
            <div>
              <label for="insurance">–°—Ç—Ä–∞—Ö—É–≤–∞–Ω–Ω—è, $</label>
              <input type="number" id="insurance" name="insurance" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="other">–Ü–Ω—à–µ, $</label>
              <input type="number" id="other" name="other" placeholder="0" />
            </div>
            <div>
              <label for="usdToUah">–ö—É—Ä—Å $ ‚Üí –≥—Ä–Ω</label>
              <input type="number" id="usdToUah" name="usdToUah" step="0.01" value="42.00" />
            </div>
          </div>

          <div class="section-title">–ë–∞–Ω–∫ / –î–æ–∫—É–º–µ–Ω—Ç–∏</div>

          <div class="row">
            <div>
              <label for="swiftFee">SWIFT, $</label>
              <input type="number" id="swiftFee" name="swiftFee" value="200" />
            </div>
            <div>
              <label for="payDocsFee">–ü–ª–∞—Ç—ñ–∂–∫–∏, $</label>
              <input type="number" id="payDocsFee" name="payDocsFee" value="95" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="transferLtFee">–ü–µ—Ä–µ–∫–∞–∑ –≤ –õ–∏—Ç–≤—É, $</label>
              <input type="number" id="transferLtFee" name="transferLtFee" value="85" />
            </div>
            <div>
              <label for="legalEntityFee">–ù–∞ —é—Ä.–æ—Å–æ–±—É, $</label>
              <input type="number" id="legalEntityFee" name="legalEntityFee" value="250" />
            </div>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" type="button" id="copyLinkBtn">üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
            <button class="btn" type="button" id="copyTextBtn">üìã –¢–µ–∫—Å—Ç</button>
          </div>
        </form>
      </div>

      <!-- RIGHT -->
      <aside class="card" id="result-card">
        <div class="result-top">
          <div>
            <div class="sum" id="totalUsd">0 $</div>
            <div class="uah" id="totalUah"></div>
            <div class="mini" id="metaLine"></div>
          </div>
          <div class="tag">–ü—ñ–¥ –∫–ª—é—á</div>
        </div>

        <div class="block">
          <div class="r"><span>–ë–∞–∑–∞</span><span id="customsBase">0 $</span></div>
          <div class="r"><span>–ú–∏—Ç–æ</span><span id="duty">0 $</span></div>
          <div class="r"><span>–ê–∫—Ü–∏–∑</span><span id="excise">0 $</span></div>
          <div class="r"><span>–ü–î–í</span><span id="vat">0 $</span></div>
          <div class="r hl"><span>–ü–æ–¥–∞—Ç–∫–∏</span><span id="taxesTotal">0 $</span></div>

          <div class="r"><span>–ü–æ—Ä—Ç–æ–≤—ñ</span><span id="portOnly">0 $</span></div>
          <div class="r"><span>–ü–æ—Å–ª—É–≥–∏ GBP</span><span id="gbpServices">0 $</span></div>
          <div class="r"><span>–ë–∞–Ω–∫</span><span id="bankFees">0 $</span></div>
          <div class="r"><span>–Ü–Ω—à–µ</span><span id="extras">0 $</span></div>

          <div class="r hl"><span>–†–∞–∑–æ–º</span><span id="grandTotal">0 $</span></div>
        </div>
      </aside>
    </section>
  </main>

  <footer>¬© Grand Best Performance ¬∑ Auto GBP</footer>

  <script>
    const form = document.getElementById("calc-form");
    const currentYear = new Date().getFullYear();

    const $ = (id)=>document.getElementById(id);
    const metaLine = $("metaLine");
    const shortStatus = $("shortStatus");

    const PARAMS = [
      "auctionUrl","vin","year","fuel","engine","auction",
      "lotPrice","auctionFee","shipUsa","shipSea","arrival","shipEuLand",
      "portFees","shipUa","dealerFee","servicePackage",
      "dutyRate","vatRate","cert","reg","repair","insurance","other",
      "usdToUah",
      "swiftFee","payDocsFee","transferLtFee","legalEntityFee"
    ];

    function num(v){
      if (v === null || v === undefined || v === "") return 0;
      const n = parseFloat(String(v).replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }
    function fmt(n){
      return (Number(n) || 0).toLocaleString("uk-UA",{maximumFractionDigits:0});
    }
    function money(usd){
      const rate = num(form.usdToUah.value);
      const usdTxt = fmt(usd) + " $";
      if (rate > 0) return usdTxt + " ¬∑ " + fmt(usd * rate) + " –≥—Ä–Ω";
      return usdTxt;
    }

    function parseAuctionUrl(url){
      try{
        const u = new URL(url);
        const host = u.hostname.toLowerCase();
        const path = (u.pathname || "").toLowerCase();

        if (host.includes("copart.com")){
          const m = path.match(/\/lot\/(\d+)/i);
          if (m) return { auction:"Copart", id:m[1] };
          const q = u.searchParams.get("lotid") || u.searchParams.get("lotId");
          if (q) return { auction:"Copart", id:q };
        }
        if (host.includes("iaai.com")){
          const m = path.match(/\/vehicledetail\/(\d+)/i);
          if (m) return { auction:"IAAI", id:m[1] };
          const q = u.searchParams.get("vehicleid") || u.searchParams.get("id");
          if (q) return { auction:"IAAI", id:q };
        }
        return null;
      }catch(e){ return null; }
    }

    function applyLot(){
      const url = (form.auctionUrl.value || "").trim();
      if (!url) return null;
      const info = parseAuctionUrl(url);
      if (!info) return null;
      form.auction.value = info.auction;
      return info;
    }

    function calcExcise(fuel, engine, age){
      let baseRate;
      if (fuel === "gasoline") baseRate = 50;
      else if (fuel === "diesel") baseRate = 75;
      else if (fuel === "hybrid") baseRate = 25;
      else baseRate = 0;
      if (baseRate <= 0 || engine <= 0) return 0;
      return (engine / 1000) * baseRate * age;
    }

    function recalc(){
      const year = parseInt(form.year.value,10) || currentYear;
      const fuel = form.fuel.value;
      const engine = num(form.engine.value);
      const age = Math.max(1, currentYear - year);

      const lotPrice   = num(form.lotPrice.value);
      const auctionFee = num(form.auctionFee.value);

      // –ë–∞–∑–∞ –¥–ª—è –º–∏—Ç–∞/–ü–î–í: —Ü—ñ–Ω–∞ + –∞—É–∫—Ü—ñ–æ–Ω–Ω—ñ + –ª–æ–≥—ñ—Å—Ç–∏–∫–∞ (—Å—É—à–∞+–º–æ—Ä–µ+–Ñ–≤—Ä–æ–ø–∞ —Å—É—à–∞)
      const shipUsa   = num(form.shipUsa.value);
      const shipSea   = num(form.shipSea.value);
      const shipEuLand= num(form.shipEuLand.value);

      // –ü–æ—Ä—Ç–æ–≤—ñ –ù–ï –≤ –±–∞–∑—ñ –ø–æ–¥–∞—Ç–∫—ñ–≤
      const portFees = num(form.portFees.value);

      const dutyRate = num(form.dutyRate.value || 10);
      const vatRate  = num(form.vatRate.value || 20);

      const gbpServices = num(form.dealerFee.value) + num(form.servicePackage.value);
      const bankFees = num(form.swiftFee.value) + num(form.payDocsFee.value) + num(form.transferLtFee.value) + num(form.legalEntityFee.value);

      const extras = num(form.shipUa.value) + num(form.cert.value) + num(form.reg.value) + num(form.repair.value) + num(form.insurance.value) + num(form.other.value);

      const customsBase = lotPrice + auctionFee + shipUsa + shipSea + shipEuLand;
      const excise = calcExcise(fuel, engine, age);
      const duty = (customsBase * dutyRate) / 100;
      const vat  = ((customsBase + duty + excise) * vatRate) / 100;
      const taxesTotal = duty + vat + excise;

      const total = customsBase + taxesTotal + portFees + gbpServices + bankFees + extras;

      $("customsBase").textContent = money(customsBase);
      $("duty").textContent = money(duty);
      $("excise").textContent = money(excise);
      $("vat").textContent = money(vat);
      $("taxesTotal").textContent = money(taxesTotal);

      $("portOnly").textContent = money(portFees);
      $("gbpServices").textContent = money(gbpServices);
      $("bankFees").textContent = money(bankFees);
      $("extras").textContent = money(extras);

      $("grandTotal").textContent = money(total);
      $("totalUsd").textContent = fmt(total) + " $";

      const rate = num(form.usdToUah.value);
      $("totalUah").textContent = rate > 0 ? ("‚âà " + fmt(total * rate) + " –≥—Ä–Ω") : "";

      // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –º–µ—Ç–∞
      const vin = (form.vin.value || "").trim().toUpperCase();
      const lot = applyLot();
      const arr = form.arrival.options[form.arrival.selectedIndex]?.text || "";
      const parts = [];
      if (lot) parts.push(lot.auction + " #" + lot.id);
      if (vin) parts.push("VIN " + vin);
      if (arr) parts.push(arr);
      metaLine.textContent = parts.join(" ¬∑ ");
    }

    function buildShareUrl(){
      const u = new URL(window.location.origin + window.location.pathname);
      const sp = new URLSearchParams();
      PARAMS.forEach(k=>{
        const field = form.elements[k];
        if (!field) return;
        const v = (field.value ?? "").toString().trim();
        if (v !== "") sp.set(k, v);
      });
      u.search = sp.toString();
      return u.toString();
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); document.body.removeChild(ta); return true; }
        catch(err){ document.body.removeChild(ta); return false; }
      }
    }

    function summaryText(){
      return [
        "Auto GBP ‚Äî –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫",
        metaLine.textContent || "",
        "",
        "–ë–∞–∑–∞: " + $("customsBase").textContent,
        "–ú–∏—Ç–æ: " + $("duty").textContent,
        "–ê–∫—Ü–∏–∑: " + $("excise").textContent,
        "–ü–î–í: " + $("vat").textContent,
        "–ü–æ–¥–∞—Ç–∫–∏: " + $("taxesTotal").textContent,
        "",
        "–ü–æ—Ä—Ç–æ–≤—ñ: " + $("portOnly").textContent,
        "–ü–æ—Å–ª—É–≥–∏ GBP: " + $("gbpServices").textContent,
        "–ë–∞–Ω–∫: " + $("bankFees").textContent,
        "–Ü–Ω—à–µ: " + $("extras").textContent,
        "",
        "–†–∞–∑–æ–º: " + $("grandTotal").textContent,
        $("totalUah").textContent ? $("totalUah").textContent : "",
        "",
        buildShareUrl()
      ].filter(Boolean).join("\n");
    }

    function loadFromParams(){
      const sp = new URLSearchParams(window.location.search);
      if ([...sp.keys()].length === 0) return;
      PARAMS.forEach(k=>{
        const v = sp.get(k);
        const field = form.elements[k];
        if (v !== null && field) field.value = v;
      });
    }

    async function decodeVin(){
      const raw = (form.vin.value || "").trim().toUpperCase();
      const vin = raw.replace(/[^A-Z0-9]/g, "");
      form.vin.value = vin;

      if (!vin || vin.length < 11){
        shortStatus.textContent = "VIN –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π";
        return;
      }

      shortStatus.textContent = "VIN‚Ä¶";

      try{
        const url = "https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/" + encodeURIComponent(vin) + "?format=json";
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json();
        const row = data?.Results?.[0];
        if (!row){ shortStatus.textContent = "VIN: –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö"; return; }

        const y = parseInt(row.ModelYear, 10);
        if (y) form.year.value = y;

        const fuelRaw = (row.FuelTypePrimary || "").toLowerCase();
        if (fuelRaw.includes("diesel")) form.fuel.value = "diesel";
        else if (fuelRaw.includes("electric")) form.fuel.value = "electric";
        else if (fuelRaw.includes("hybrid")) form.fuel.value = "hybrid";
        else if (fuelRaw) form.fuel.value = "gasoline";

        const cc = parseInt(row.DisplacementCC, 10);
        if (cc) form.engine.value = cc;
        else if (row.DisplacementL){
          const l = num(row.DisplacementL);
          if (l > 0) form.engine.value = Math.round(l * 1000);
        }

        shortStatus.textContent = "VIN OK";
        recalc();
      }catch(e){
        shortStatus.textContent = "VIN: –ø–æ–º–∏–ª–∫–∞";
      }
    }

    // events
    form.querySelectorAll("input,select").forEach(x=>{
      x.addEventListener("input", recalc);
      x.addEventListener("change", recalc);
    });

    $("recognizeLotBtn").addEventListener("click", ()=>{
      const lot = applyLot();
      shortStatus.textContent = lot ? (lot.auction + " OK") : "–õ–æ—Ç –Ω–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ";
      recalc();
    });

    $("decodeVinBtn").addEventListener("click", decodeVin);

    $("copyLinkBtn").addEventListener("click", async ()=>{
      recalc();
      const ok = await copyText(buildShareUrl());
      shortStatus.textContent = ok ? "–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ" : "–ù–µ —Å–∫–æ–ø—ñ—é–≤–∞–ª–æ";
      setTimeout(()=>shortStatus.textContent="", 1400);
    });

    $("copyTextBtn").addEventListener("click", async ()=>{
      recalc();
      const ok = await copyText(summaryText());
      shortStatus.textContent = ok ? "–¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ" : "–ù–µ —Å–∫–æ–ø—ñ—é–≤–∞–ª–æ";
      setTimeout(()=>shortStatus.textContent="", 1400);
    });

    // init
    loadFromParams();
    recalc();
  </script>
</body>
</html>
